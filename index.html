<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced JSON Tool with Multiple Inputs - Dark Theme</title>
<style>
  /* Dark Theme */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1e1e2f;
    margin: 0; padding: 20px;
    color: #ccc;
  }
  h2 {
    text-align: center;
    color: #eee;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: #2a2a40;
    border-radius: 8px;
    padding: 15px 25px 30px 25px;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.7);
  }
  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 2px solid #444;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  .tab {
    position: relative;
    padding: 10px 35px 10px 20px;
    cursor: pointer;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    background: #3a3a5a;
    color: #bbb;
    margin-right: 7px;
    margin-bottom: 5px;
    user-select: none;
    transition: background 0.3s, color 0.3s;
  }
  .tab.active {
    background: #5e81f4;
    color: #fff;
    font-weight: bold;
  }
  .tab .delete-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    background: #bf616a;
    border: none;
    color: white;
    font-weight: bold;
    font-size: 13px;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    line-height: 18px;
  }
  /* Textarea */
  .json-input-area {
    margin-bottom: 15px;
  }
  textarea {
    width: 100%;
    height: 180px;
    font-family: monospace;
    font-size: 14px;
    border: 1px solid #555;
    border-radius: 6px;
    padding: 10px;
    box-sizing: border-box;
    resize: vertical;
    background-color: #1f1f2e;
    color: #ddd;
  }
  textarea::selection {
    background: #5e81f4;
    color: #fff;
  }
  /* Buttons */
  .buttons {
    margin-bottom: 15px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .buttons button {
    background: #5e81f4;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  .buttons button:hover {
    background: #4a69d6;
  }
  /* JSON tree */
  .json-tree {
    font-family: monospace;
    background: #1f1f2e;
    padding: 12px 15px;
    border: 1px solid #555;
    overflow: auto;
    max-height: 360px;
    white-space: pre-wrap;
    border-radius: 6px;
    color: #ddd;
  }
  .key { color: #81a1c1; }
  .string { color: #a3be8c; }
  .number { color: #b48ead; }
  .boolean { color: #d08770; }
  .null { color: #bf616a; font-style: italic; }
  .expandable { cursor: pointer; user-select: none; margin-right: 5px; font-weight: 600; }
  .collapsed > ul { display: none; }
  /* File input */
  .file-inputs {
    margin-bottom: 20px;
  }
  .file-inputs input[type='file'] {
    margin-right: 15px;
  }
  #filesList {
    font-size: 14px;
    color: #aaa;
    margin-bottom: 15px;
  }
  /* Diff lines highlight */
  .diff-line {
    font-family: monospace;
    white-space: pre;
  }
  .diff-add {
    background-color: #434f3b;
    color: #a3be8c; /* green */
  }
  .diff-del {
    background-color: #543f43;
    color: #bf616a; /* red */
  }
  .diff-unchanged {
    background-color: transparent;
    color: #ddd;
  }
</style>
</head>
<body>
<div class="container">
  <h2>Advanced JSON Tool with Multiple Inputs - Dark Theme</h2> <button onclick="location.href='qr-util.html'">Go to Index Page</button>
  <div class="file-inputs">
    <input type="file" id="jsonFiles" multiple accept="application/json" />
    <button onclick="addNewInput()">New Input</button>
    <button onclick="loadLocalStorage()">Load All from LocalStorage</button>
    <button onclick="saveLocalStorage()">Save All to LocalStorage</button>
  </div>
  <div id="filesList">Loaded JSON inputs: 0</div>
  <div class="tabs" id="inputTabs"></div>
  <div id="inputsContainer"></div>
  <div class="buttons">
    <button onclick="formatJSON()">Format JSON</button>
    <button onclick="stringifyJSON()">JSON.stringify()</button>
    <button onclick="parseStringifiedJSON()">Parse Escaped String</button>
    <button onclick="parseJSON()">Parse & Display Tree</button>
    <button onclick="removeWhitespace()">Remove Whitespace</button>
    <button onclick="exportJSON()">Export JSON</button>
    <button onclick="copyToClipboard()">Copy</button>
    <button onclick="compareKeys()">Compare Keys (Input 1 vs 2)</button>
    <button onclick="compareText()">Compare Text (Input 1 vs 2)</button>
    <button onclick="extractKeys()">Extract Keys</button>
    <button onclick="convertToCSV()">Convert JSON to CSV</button>
    <button onclick="convertFromCSV()">Convert CSV to JSON</button>
  </div>
  <div class="json-tree" id="jsonTree"></div>
</div>

<script>
let jsonInputs = [];
let activeIndex = -1;

function tryPrettyFormat(jsonStr) {
  try {
    const obj = JSON.parse(jsonStr);
    return JSON.stringify(obj, null, 2);
  } catch {
    return jsonStr;
  }
}

function addNewInput(initialContent = '{\n  \n}') {
  initialContent = tryPrettyFormat(initialContent);
  const idx = jsonInputs.length;
  jsonInputs.push(initialContent);
  renderTabs();
  renderInputs();
  setActiveInput(idx);
  updateFilesList();
}

function renderTabs() {
  const tabs = document.getElementById('inputTabs');
  tabs.innerHTML = '';
  jsonInputs.forEach((content, index) => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (index === activeIndex ? ' active' : '');
    tab.textContent = 'Input ' + (index + 1);

    // Add delete button to tab
    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = 'Ã—';
    delBtn.title = 'Delete this input';
    delBtn.onclick = (ev) => {
      ev.stopPropagation();
      deleteInput(index);
    };
    tab.appendChild(delBtn);

    tab.onclick = () => setActiveInput(index);
    tabs.appendChild(tab);
  });
}

function deleteInput(index) {
  if(index < 0 || index >= jsonInputs.length) return;
  jsonInputs.splice(index, 1);
  if(activeIndex === index) {
    activeIndex = index === 0 ? 0 : index - 1;
  } else if(activeIndex > index) {
    activeIndex--;
  }
  if(jsonInputs.length === 0) {
    addNewInput();
  } else {
    renderTabs();
    renderInputs();
    setActiveInput(activeIndex);
    updateFilesList();
  }
}

function renderInputs() {
  const container = document.getElementById('inputsContainer');
  container.innerHTML = '';
  jsonInputs.forEach((content, index) => {
    const txt = document.createElement('textarea');
    txt.id = 'jsonInput_' + index;
    txt.value = content;
    txt.className = 'json-input-area';
    txt.style.display = (index === activeIndex) ? 'block' : 'none';
    txt.addEventListener('input', () => {
      jsonInputs[index] = txt.value;
    });
    container.appendChild(txt);
  });
}

function setActiveInput(index) {
  activeIndex = index;
  renderTabs();
  renderInputs();
  displayTreeSafe(jsonInputs[activeIndex]);
}

function updateFilesList() {
  const text = 'Loaded JSON inputs: ' + jsonInputs.length;
  document.getElementById('filesList').textContent = text;
}

document.getElementById('jsonFiles').addEventListener('change', (e) => {
  const files = e.target.files;
  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      addNewInput(reader.result);
    };
    reader.readAsText(file);
  });
});

function loadLocalStorage() {
  const saved = localStorage.getItem('savedJsonInputs');
  if (saved) {
    jsonInputs = JSON.parse(saved);
    if(jsonInputs.length === 0) jsonInputs.push('{\n  \n}');
    jsonInputs = jsonInputs.map(i => tryPrettyFormat(i));
    activeIndex = 0;
    renderTabs();
    renderInputs();
    displayTreeSafe(jsonInputs[activeIndex]);
    updateFilesList();
    alert('Loaded all JSON inputs from LocalStorage');
  } else {
    alert('No saved JSON inputs found in LocalStorage');
  }
}

function saveLocalStorage() {
  localStorage.setItem('savedJsonInputs', JSON.stringify(jsonInputs));
  alert('Saved all JSON inputs to LocalStorage');
}

// Minimal safe JSON pretty print without parsing numbers
function safePrettyPrint(jsonStr) {
  let indent = 0;
  const indentStr = '  ';
  let inString = false;
  let result = '';
  for (let i=0; i<jsonStr.length; i++) {
    let char = jsonStr[i];
    if (char === '"' && jsonStr[i-1] !== '\\') {
      inString = !inString;
      result += char;
      continue;
    }
    if (inString) {
      result += char;
      continue;
    }
    if (char === '{' || char === '[') {
      result += char + '\n' + indentStr.repeat(++indent);
    } else if (char === '}' || char === ']') {
      result += '\n' + indentStr.repeat(--indent) + char;
    } else if (char === ',') {
      result += char + '\n' + indentStr.repeat(indent);
    } else if (char === ':') {
      result += ': ';
    } else if (char === '\n' || char === '\r') {
      // ignore existing newlines
    } else {
      result += char;
    }
  }
  return result;
}

function formatJSON() {
  try {
    const txt = jsonInputs[activeIndex];
    const pretty = safePrettyPrint(txt);
    jsonInputs[activeIndex] = pretty;
    document.getElementById('jsonInput_' + activeIndex).value = pretty;
  } catch (e) {
    alert('Error formatting JSON: ' + e.message);
  }
}




// Stringify JSON to escaped JSON string (like provided example)
function stringifyJSON() {
  try {
    const obj = JSON.parse(jsonInputs[activeIndex]); // parse current input to object
    const jsonText = JSON.stringify(obj); // normal JSON string
    const escapedJsonString = JSON.stringify(jsonText); // double stringify to escape quotes
    jsonInputs[activeIndex] = escapedJsonString;
    document.getElementById('jsonInput_' + activeIndex).value = escapedJsonString;
  } catch (e) {
    alert('Invalid JSON on active Input: ' + e.message);
  }
}

// Parse the escaped JSON string back into normal pretty JSON text
function parseStringifiedJSON() {
  try {
    const input = jsonInputs[activeIndex];
    // Parse once to get JSON string, then parse again to get object
    const jsonText = JSON.parse(input);
    const obj = JSON.parse(jsonText);
    const pretty = JSON.stringify(obj, null, 2);
    jsonInputs[activeIndex] = pretty;
    document.getElementById('jsonInput_' + activeIndex).value = pretty;
    displayTreeSafe(pretty);
  } catch (e) {
    alert('Invalid escaped JSON string on active Input: ' + e.message);
  }
}


function parseJSON() {
  displayTreeSafe(jsonInputs[activeIndex]);
}

function removeWhitespace() {
  try {
    const input = jsonInputs[activeIndex];
    // Parse JSON, then stringify without spaces/newlines to minify preserving all internal spaces
    const obj = JSON.parse(input);
    const minified = JSON.stringify(obj);
    jsonInputs[activeIndex] = minified;
    document.getElementById('jsonInput_' + activeIndex).value = minified;
  } catch (e) {
    alert('Invalid JSON on active Input: ' + e.message);
  }
}


function exportJSON() {
  try {
    const txt = jsonInputs[activeIndex];
    const blob = new Blob([txt], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'export_input_' + (activeIndex + 1) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    alert('Error exporting JSON: ' + err.message);
  }
}

// Copy current active input content to clipboard
function copyToClipboard() {
  try {
    const txt = jsonInputs[activeIndex];
    navigator.clipboard.writeText(txt).then(() => {
      alert('Copied to clipboard!');
    }, () => {
      alert('Failed to copy to clipboard');
    });
  } catch (err) {
    alert('Error copying: ' + err.message);
  }
}

function compareKeys() {
  try {
    if(jsonInputs.length < 2) {
      alert('Need at least two inputs to compare keys');
      return;
    }
    const obj1 = JSON.parse(jsonInputs[0]);
    const obj2 = JSON.parse(jsonInputs[1]);
    const keys1 = new Set(Object.keys(obj1));
    const keys2 = new Set(Object.keys(obj2));
    const common = [...keys1].filter(k => keys2.has(k));
    const onlyFirst = [...keys1].filter(k => !keys2.has(k));
    const onlySecond = [...keys2].filter(k => !keys1.has(k));
    const result = {
      commonKeys: common,
      onlyFirstFileKeys: onlyFirst,
      onlySecondFileKeys: onlySecond
    };
    const formatted = JSON.stringify(result, null, 2);
    addNewInput(formatted);
    setActiveInput(jsonInputs.length - 1);
  } catch (err) {
    alert('Error comparing keys: ' + err.message);
  }
}

function compareText() {
  try {
    if(jsonInputs.length < 2) {
      alert('Need at least two inputs to compare text');
      return;
    }
    const text1 = jsonInputs[0];
    const text2 = jsonInputs[1];
    const diffs = diffTextLines(text1, text2);
    const combinedText = diffs.map(d => d.text).join('\n');
    addNewInput(combinedText);
    setActiveInput(jsonInputs.length - 1);
    showDiffHighlighted(diffs);
  } catch (err) {
    alert('Error comparing text: ' + err.message);
  }
}

function diffTextLines(t1, t2) {
  const a = t1.split('\n');
  const b = t2.split('\n');
  let maxLen = Math.max(a.length, b.length);
  let result = [];
  for(let i=0; i<maxLen; i++) {
    const lineA = a[i] ?? '';
    const lineB = b[i] ?? '';
    if(lineA !== lineB) {
      if(lineA !== '') result.push({ text: '- ' + lineA, type: 'del' });
      if(lineB !== '') result.push({ text: '+ ' + lineB, type: 'add' });
    } else {
      result.push({ text: '  ' + lineA, type: 'unchanged' });
    }
  }
  return result;
}

function showDiffHighlighted(diffLines) {
  const container = document.getElementById('jsonTree');
  container.innerHTML = '';
  const ul = document.createElement('ul');
  ul.style.listStyle = 'none';
  ul.style.paddingLeft = '5px';

  diffLines.forEach(d => {
    const li = document.createElement('li');
    li.textContent = d.text;
    li.classList.add('diff-line');
    if(d.type === 'add') li.classList.add('diff-add');
    else if(d.type === 'del') li.classList.add('diff-del');
    else li.classList.add('diff-unchanged');
    ul.appendChild(li);
  });
  container.appendChild(ul);
}

function extractKeys() {
  try {
    const obj = JSON.parse(jsonInputs[activeIndex]);
    const keys = new Set();
    function recurse(o) {
      if (typeof o === 'object' && o !== null) {
        for (const k in o) {
          keys.add(k);
          recurse(o[k]);
        }
      }
    }
    recurse(obj);
    const result = [...keys];
    const formatted = JSON.stringify(result, null, 2);
    addNewInput(formatted);
    setActiveInput(jsonInputs.length - 1);
  } catch (err) {
    alert('Error extracting keys: ' + err.message);
  }
}

function convertToCSV() {
  try {
    const arr = JSON.parse(jsonInputs[activeIndex]);
    if (!Array.isArray(arr)) {
      alert('JSON must be an array of objects to convert to CSV');
      return;
    }
    const keys = [...new Set(arr.flatMap(obj => Object.keys(obj)))];
    const csv = [keys.join(',')];
    for (const obj of arr) {
      csv.push(keys.map(k => JSON.stringify(obj[k] ?? '')).join(','));
    }
    jsonInputs[activeIndex] = csv.join('\n');
    document.getElementById('jsonInput_' + activeIndex).value = jsonInputs[activeIndex];
  } catch (err) {
    alert('Error converting to CSV: ' + err.message);
  }
}

function convertFromCSV() {
  try {
    const txt = jsonInputs[activeIndex].trim();
    const lines = txt.split('\n');
    if(lines.length < 2) {
      alert('CSV must have at least 2 lines');
      return;
    }
    const headers = lines[0].split(',');
    const result = [];
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
      const obj = {};
      for(let j=0; j<headers.length; j++) {
        let val = values[j];
        try {
          val = JSON.parse(val);
        } catch(e) {
          // keep as string
        }
        obj[headers[j]] = val;
      }
      result.push(obj);
    }
    jsonInputs[activeIndex] = JSON.stringify(result, null, 2);
    document.getElementById('jsonInput_' + activeIndex).value = jsonInputs[activeIndex];
  } catch (err) {
    alert('Error converting CSV to JSON: ' + err.message);
  }
}

function displayTreeSafe(text) {
  try {
    const obj = JSON.parse(text);
    displayTree(obj);
  } catch {
    document.getElementById('jsonTree').textContent = 'Invalid JSON to display tree';
  }
}

function displayTree(data) {
  const container = document.getElementById('jsonTree');
  container.innerHTML = '';

  function createNode(key, value) {
    const node = document.createElement('li');

    if (typeof value === 'object' && value !== null) {
      const span = document.createElement('span');
      span.textContent = '[+] ' + key;
      span.classList.add('expandable');
      span.onclick = () => {
        if (node.classList.contains('collapsed')) {
          node.classList.remove('collapsed');
          span.textContent = '[-] ' + key;
        } else {
          node.classList.add('collapsed');
          span.textContent = '[+] ' + key;
        }
      };
      node.appendChild(span);

      const ul = document.createElement('ul');
      ul.style.listStyle = 'none';
      ul.style.paddingLeft = '20px';

      for (const k in value) {
        ul.appendChild(createNode(k, value[k]));
      }
      node.appendChild(ul);

      node.classList.add('collapsed');
    } else {
      const spanKey = document.createElement('span');
      spanKey.textContent = key + ': ';
      spanKey.classList.add('key');

      const spanValue = document.createElement('span');
      if (typeof value === 'string') {
        spanValue.textContent = '"' + value + '"';
        spanValue.classList.add('string');
      } else if (typeof value === 'number') {
        spanValue.textContent = value;
        spanValue.classList.add('number');
      } else if (typeof value === 'boolean') {
        spanValue.textContent = value;
        spanValue.classList.add('boolean');
      } else if (value === null) {
        spanValue.textContent = 'null';
        spanValue.classList.add('null');
      } else {
        spanValue.textContent = String(value);
      }
      node.appendChild(spanKey);
      node.appendChild(spanValue);
    }
    return node;
  }

  const rootUl = document.createElement('ul');
  rootUl.style.listStyle = 'none';
  if(typeof data === 'object' && data !== null){
    for(const key in data){
      rootUl.appendChild(createNode(key, data[key]));
    }
  } else {
    rootUl.textContent = String(data);
  }
  container.appendChild(rootUl);
}

window.onload = () => {
  addNewInput();
};
</script>
</body>
</html>

